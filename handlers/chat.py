"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
"""
import structlog
from telegram import Update
from telegram.ext import ContextTypes
from database import db
from middlewares.rate_limit import rate_limit_middleware
from middlewares.usage_limit import check_can_make_request
from utils.i18n import t
from services.memory import extract_and_save_facts
from handlers.chat_utils import (
    is_image_request,
    handle_image_request,
    handle_multimodal_request,
    handle_text_request
)

logger = structlog.get_logger(__name__)


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    if await db.is_banned(user_id):
        await update.message.reply_text("‚õî –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞.")
        return
    user_message = update.message.text
    logger.info("message_received", user_id=user_id, text_len=len(user_message))

    # RAG Lite: –∏–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–∫—Ç—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    await extract_and_save_facts(user_id, user_message)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limit
    if not await rate_limit_middleware.check_rate_limit(user_id):
        await update.message.reply_text(
            t("rate_limit") + f" {rate_limit_middleware.time_window} —Å–µ–∫.\nüí° –õ–∏–º–∏—Ç: {rate_limit_middleware.max_requests} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É",
            parse_mode=None
        )
        return

    # –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (10/–¥–µ–Ω—å)
    can_proceed, limit_msg = await check_can_make_request(user_id)
    if not can_proceed:
        await update.message.reply_text(limit_msg, parse_mode=None)
        return
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if is_image_request(user_message):
        await handle_image_request(update, context)
        return
    
    # –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    if await handle_multimodal_request(update, context):
        return

    # –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
    await handle_text_request(update, context)
